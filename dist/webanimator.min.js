function Extender(t){this.parent=t}function extend(t){return new Extender(t)}function Exception(t){this.message=t}function UnimplementedError(t){Exception.call(this,t)}function MissingValueError(t){Exception.call(this,t)}function requestFullscreen(t){t.fullscreen=t.mozRequestFullScreen||t.webkitRequestFullScreen,t.fullscreen()}function AnimationController(){}function Model(){}function Model2d(){this.objects=[]}function Object2d(){if(arguments.length<1)throw new MissingValueError("Must specify object shape");this.shape=arguments[0],this.translation=new Translation(0,0),this.rotation=new Rotation(0),arguments.length>=2&&(this.translation=new Translation(arguments[1],arguments[2]),arguments.length>=4&&(this.rotation=new Rotation(arguments[3]),arguments.length>=5&&(this.fill=arguments[4])))}function Circle(){Object2d.apply(this,["circle"].concat(Array.prototype.slice.call(arguments))),this.radius=0}function Rectangle(){Object2d.apply(this,["rectangle"].concat(Array.prototype.slice.call(arguments)))}function Line(){Object2d.apply(this,["line"].concat(Array.prototype.slice.call(arquments)))}function Polyline(){Object2d.apply(this,["line"].concat(Array.prototype.slice.call(arquments)))}function Polygon(){Object2d.apply(this,["polygon"].concat(Array.prototype.slice.call(arquments)))}function Path(){Object2d.apply(this,["path"].concat(Array.prototype.slice.call(arquments)))}function Transformation(t){this.mat=t}function Translation(t,e){this.mat=mat3.create(),this.translation_vec=vec3.fromValues(t,e,1),mat3.translate(this.mat,this.mat,this.translation_vec)}function Rotation(t){this.mat=mat3.create(),this.angle=t,mat3.rotate(this.mat,this.mat,t)}function Scale(t,e){"undefined"==typeof e&&(e=t),this.mat=mat3.create(),mat3.scale(this.mat,this.mat,vec2.fromValues(t,e))}function Renderer(){}function createSvgElement(t){return document.createElementNS("http://www.w3.org/2000/svg",t)}function SvgElement(t){if("undefined"!=typeof t&&(this.element=createSvgElement(t),2==arguments.length)){var e=arguments[1];for(var n in e)this.setAttribute(n,e[n])}}function SvgRoot(t,e,n){this.element=createSvgElement("svg"),this.properties={},this.element.setAttribute("viewbox","0 0 "+t+" "+e),this.element.setAttribute("width",t),this.element.setAttribute("height",e),"undefined"!=typeof n&&this.element.addEventListener("click",function(){requestFullscreen(this)})}function SvgRectangle(){SvgElement.call(this,"rect",arguments[0])}function SvgCircle(){SvgElement.call(this,"circle",arguments[0])}function SvgEllipse(){SvgElement.call(this,"ellipse",arguments[0])}function SvgPath(){SvgElement.call(this,"path",arguments[0])}function SvgLine(){SvgElement.call(this,"line",arguments[0])}function SvgPolyline(){SvgElement.call(this,"polyline",arguments[0])}function SvgPolygon(){SvgElement.call(this,"polygon",arguments[0])}function SvgRenderer(){this.model=null,this.svgElements=[],this.rootElement=null}Extender.prototype.withObject=function(t){t.prototype=Object.create(this.parent.prototype),t.prototype.constructor=t},Exception.prototype.toString=function(){return this.constructor.name+": "+this.message},extend(Exception).withObject(UnimplementedError),extend(Exception).withObject(MissingValueError);var elementToObject=function(){var t={rect:Rectangle,circle:Circle,line:Line,polyline:Polyline,path:Path},e=function(e){var n=new t[e.nodeName];if(e.hasAttribute("fill")&&n.setFillColor(e.attributes.fill.value),e.hasAttribute("transform")){var i=e.attributes.transform.value.match(/(\d+(\.\d+)?(,\s*)?)+/)[0].split(",").map(function(t){return+t});n.setPosition(i[4],i[5]),n.setRotation(Math.acos(i[0]))}return n},n={circle:function(t){var n=e(t);return t.hasAttribute("r")&&n.setRadius(t.attributes.r.value),(t.hasAttribute("cx")||t.hasAttribute("cy"))&&(n.setPosition(n.translation.getX()+(+t.attributes.cx.value||0),n.translation.getY()+(+t.attributes.cy.value||0)),t.removeAttribute("cx"),t.removeAttribute("cy")),n},rect:function(t){var n=e(t);return(t.hasAttribute("x")||t.hasAttribute("y"))&&n.setPosition(n.translation.getX()+(+t.attributes.x.value||0),n.translation.getY()+(+t.attributes.y.value||0)),t.hasAttribute("width")&&n.setWidth(t.attributes.width.value),t.hasAttribute("height")&&n.setHeight(t.attributes.height.value),n},line:function(t){return e(t)},polyline:function(t){return e(t)},polygon:function(t){return e(t)},path:function(t){return e(t)}};return function(t){return n[t.nodeName](t)}}();AnimationController.prototype.setModel=function(t){return this.model=t,this},AnimationController.prototype.setRenderer=function(t){return this.renderer=t,this},AnimationController.prototype.start=function(){!function(t,e){!function n(i){t.advance(i),e.render(),window.requestAnimationFrame(n)}(0)}(this.model,this.renderer)},Model.prototype.advance=function(){throw new UnimplementedError("Function 'advance' is not defined for this model")},extend(Model).withObject(Model2d),Model2d.prototype.addObject=function(t){return this.objects.push(t),this},Object2d.prototype.set=function(t,e){return this[t]=e,this},Object2d.prototype.setPosition=function(t,e){return"undefined"==typeof this.translation||this.translation===Transformation.IDENTITY?this.translation=new Translation(t,e):this.translation.setPosition(t,e),this},Object2d.prototype.setRotation=function(t){return"undefined"==typeof this.rotation||this.rotation===Transformation.IDENTITY?this.rotation=new Rotation(t):this.rotation.setAngle(t),this},Object2d.prototype.getTransformation=function(){return this.rotation.combine(this.translation)},Object2d.prototype.setFillColor=function(t){return this.set("fill",t)},extend(Object2d).withObject(Circle),Circle.prototype.setRadius=function(t){return this.set("radius",t)},extend(Object2d).withObject(Rectangle),Rectangle.prototype.setWidth=function(t){return this.set("width",t)},Rectangle.prototype.setHeight=function(t){return this.set("height",t)},extend(Object2d).withObject(Line),extend(Object2d).withObject(Polyline),extend(Object2d).withObject(Polygon),extend(Object2d).withObject(Path);var I3=mat3.create();Transformation.IDENTITY=new Transformation(mat3.create()),Transformation.prototype.transform=function(t){vec3.transformMat3(t,t,this.mat)},Transformation.prototype.transformed=function(t){var e=vec3.create();return vec3.transformMat3(e,t,this.mat),e},Transformation.prototype.combine=function(t){var e=mat3.create();return mat3.multiply(e,this.mat,t.mat),new Transformation(e)},extend(Transformation).withObject(Translation),Translation.prototype.setPosition=function(t,e){vec3.set(this.translation_vec,t,e,1),mat3.translate(this.mat,I3,this.translation_vec)},Translation.prototype.getX=function(){return this.mat[6]},Translation.prototype.getY=function(){return this.mat[7]},extend(Transformation).withObject(Rotation),Rotation.prototype.setAngle=function(t){this.angle=t,mat3.rotate(this.mat,I3,this.angle)},Rotation.prototype.getAngle=function(){return this.angle},extend(Transformation).withObject(Scale),Renderer.prototype.render=function(){throw new UnimplementedError("Function 'render' is not defined for this model")},SvgElement.fromExisting=function(t){var e=new SvgElement;return e.element=t,e},SvgElement.prototype.setAttribute=function(t,e){return this.element.setAttribute(t,e),this},SvgElement.prototype.setFill=function(t){return this.setAttribute("fill",t)},SvgElement.prototype.setTransform=function(t){var e="matrix(";return e+=t.mat[0]+",",e+=t.mat[1]+",",e+=t.mat[3]+",",e+=t.mat[4]+",",e+=t.mat[6]+",",e+=t.mat[7]+")",this.setAttribute("transform",e)},extend(SvgElement).withObject(SvgRoot),SvgRoot.prototype.addElement=function(t){this.element.appendChild(t.element)},SvgRoot.fullScreenSvgForWindow=function(){return new SvgRoot(window.innerWidth,window.innerHeight,!0)},extend(SvgElement).withObject(SvgRectangle),SvgRectangle.prototype.setWidth=function(t){return this.setAttribute("width",t)},SvgRectangle.prototype.setHeight=function(t){return this.setAttribute("height",t)},extend(SvgElement).withObject(SvgCircle),SvgCircle.prototype.setRadius=function(t){return this.setAttribute("r",t)},extend(SvgElement).withObject(SvgEllipse),extend(SvgElement).withObject(SvgPath),extend(SvgElement).withObject(SvgLine),extend(SvgElement).withObject(SvgPolyline),extend(SvgElement).withObject(SvgPolygon);var objectToElement={circle:function(t){return(new SvgCircle).setRadius(t.radius).setTransform(t.getTransformation()||Transformation.IDENTITY).setFill(t.fill||"#ffffff")},rectangle:function(t){return(new SvgRectangle).setWidth(t.width||0).setHeight(t.height||0).setFill(t.fill||"#ffffff")}};extend(Renderer).withObject(SvgRenderer),SvgRenderer.prototype.attachTo=function(t){t.appendChild(this.rootElement.element)},SvgRenderer.prototype.addElement=function(t){this.elements.push(t)},SvgRenderer.prototype.render=function(){for(var t in this.svgElements)this.svgElements[t].setTransform(this.model.objects[t].getTransformation())},SvgRenderer.fromModel=function(t,e,n,i){var r=new SvgRenderer;r.model=t,r.rootElement=i?SvgRoot.fullScreenSvgForWindow():new SvgRoot(e,n,!1);for(var o in t.objects){var a=t.objects[o],s=objectToElement[a.shape](a)||null;null!==s&&(r.svgElements[o]=s,r.rootElement.addElement(s))}return r},SvgRenderer.fromGraphic=function(t,e){var n=new SvgRenderer,i=new Model2d,r=SvgElement.fromExisting(t);e&&r.element.addEventListener("click",function(){requestFullscreen(r.element)}),n.rootElement=r,n.model=i;for(var o=0,a=r.element.childElementCount;a>o;o++){var s=r.element.children[o];i.addObject(elementToObject(s)),n.svgElements.push(SvgElement.fromExisting(s))}return n};